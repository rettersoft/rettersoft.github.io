# iOS

[![CI Status](https://img.shields.io/travis/baranbaygan/RBS.svg?style=flat)](https://travis-ci.org/baranbaygan/RBS)
[![Version](https://img.shields.io/cocoapods/v/RBS.svg?style=flat)](https://cocoapods.org/pods/RBS)
[![License](https://img.shields.io/cocoapods/l/RBS.svg?style=flat)](https://cocoapods.org/pods/RBS)
[![Platform](https://img.shields.io/cocoapods/p/RBS.svg?style=flat)](https://cocoapods.org/pods/RBS)

## Example

To run the example project, clone the repo, and run `pod install` from the Example directory first.

## About RBS

RBS can be used by developers to build event based systems. You should create an RBS account and an RBS project to start. 

https://console.retter.io

## Requirements

You need to have a RTBS projectId.

## Installation

### Cocoapods

RTBS is available through [CocoaPods](https://cocoapods.org). To install
it, simply add the following line to your Podfile:

```ruby
pod 'RBS'
```

### Swift Package Manager

You can use swift package manager with following repo url and using main branch:

```
https://github.com/rettersoft/rbs-ios-sdk
```

## Initialize SDK

Initialize the SDK with your project id created in RBS console.

```typescript
let rbs = RBS(config: RBSConfig(projectId: "{PROJECT_ID}"))
```

## Authenticate 

RBS client's authenticateWithCustomToken method should be used to authenticate a user. If you don't call this method, client will send actions as an anonymous user.

```typescript
rbs.authenticateWithCustomToken(customToken)
```

RBS custom tokens can be generated by a RBS service by contacting RBS core service via RBS SDK.

- A client app sends a request to a RBS service which has permission to generate RBS custom tokens.
- RBS Service uses RBS SDK on the server side to communicate with RBS Core to generate custom token with user credentials.
- RBS Core creates a custom token and returns it to the service.
- The service returns it to the client application.
- The client application uses RBS SDK authenticateWithCustomToken method to sign in as this user. From that point on any request made by this client, is recognized as this user by all RBS services.

You can sign out with .signout method.

```typescript
rbs.signOut()
```

## RBS Delegate

You can attach a delegate to RBS client.

```typescript
rbs.delegate = self
```

And start receiving authentication state changes.

```typescript
extension ViewController : RBSClientDelegate {
    func rbsClient(client: RBS, authStatusChanged toStatus: RBSClientAuthStatus) {
        print("RBS authStatusChanged to \(toStatus)")
    }
}
```

## Cloud Objects

```typescript
var cloudObject: RBSCloudObject?
```

Now let's get this object from the server:

```typescript
rbs.getCloudObject(with: RBSCloudObjectOptions(classID: "ChatRoom", instanceID: "01FPJX38KE3G8HBQ49VMF2KC3C")) { [weak self] (newObject) in
    print("--- Cloud Object Created ---")
    self?.cloudObject = newObject
} onError: { (error) in
    print(error)
}
```

__RBSCloudObjectOptions__

```typescript

public struct RBSCloudObjectOptions {
    public var classID: String?
    public var instanceID: String?
    public var keyValue: (key: String, value: String)?
    public var method: String?
    public var headers: [String: String]?
    public var queryString: [String: String]?
    public var httpMethod: Moya.Method?
    public var body: [String: Any]?
}
```

Listen to state updates:

```typescript
self.cloudObject.state.user.subscribe { (data) in
   print("---User State ->", data)
} errorFired: { (error) in
   print("---User State Error ->", error)
}

self.cloudObject.state.role.subscribe { (data) in
   print("---RoleState State ->", data)
} errorFired: { (error) in
   print("---Role State Error ->", error)
}

self.cloudObject.state.public.subscribe { (data) in
   print("---Public State ->", data)
} errorFired: { (error) in
   print("---Public State Error ->", error)
}
```

Let's call a method on an object:

```typescript
cloudObject
   .call(with: RBSCloudObjectOptions(method: "sayHello")) { (response:RBSCloudObjectResponse) in
      
   } onError: { (error:RBSCloudObjectError) in
      
   }
```

### Response and Error structures SDK returns
```typescript
public struct RBSCloudObjectResponse {
    public let statusCode: Int
    public let headers: [String:String]?
    public let body: Data?
}
public struct RBSCloudObjectError: Error {
    public let error: RBSError
    public let response: RBSCloudObjectResponse?
}
public enum RBSError : Error {
    case TokenError,
         cloudNotConfigured,
         classIdRequired,
         cloudObjectNotFound,
         methodReturnedError,
         parsingError
}
```

### Example iOS Client Code with Cloud Objects

```typescript

// Some models
class BaseError: Decodable {
    var validationErrors: ValidationErrors? = nil
}

class SignInErrorResponse: BaseError {
    var error: String? = nil
}

struct SignInResponse: Decodable {
    let customToken: String
}

// A button tap handler
@IBAction func btnLoginTapped(_ sender: Any) {
   
   guard let username = self.txtUsername.text, let password = self.txtPassword.text else { return }
   
   self
      .rbs?
      .getCloudObject(with: RBSCloudObjectOptions(classID: "User", keyValue: ("username", username)), onSuccess: { cloudObject in
            
            
            cloudObject.call(with: RBSCloudObjectOptions(method: "signin", body: ["password": password])) { response in
               // response is type of RBSCloudObjectResponse
               // you can parse its body to your model like below:
               if let body = response.body {
                  let signInResponse: SignInResponse = try! JSONDecoder().decode(SignInResponse.self, from: body)
                  print(signInResponse)
               }
            } onError: { error in
               // error is type of RBSCloudObjectError
               // you can also parse error response body to your error model like below:
               if let response = error.response, let body = response.body {
                  let signInErrorResponse: SignInErrorResponse = try! JSONDecoder().decode(SignInErrorResponse.self, from: body)
                  print(signInErrorResponse)
               }
            }
            
      }, onError: { error in
            
            // error is type of RBSCloudObjectError
            print(error)
            
      })
}
```
